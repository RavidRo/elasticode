stages:
  - check
  - build
  - publish

# ──────────────────────────────────────────────
# Check stage: runs on every push and MR
# ──────────────────────────────────────────────

.check-base:
  stage: check
  image: python:3.13-slim
  before_script:
    - pip install uv
    - uv sync
  cache:
    key:
      files:
        - uv.lock
    paths:
      - .venv/
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG

lint:
  extends: .check-base
  script:
    - uv run ruff check src/ tests/

format-check:
  extends: .check-base
  script:
    - uv run ruff format --check src/ tests/

typecheck:
  extends: .check-base
  script:
    - uv run mypy src/ tests/

test:
  extends: .check-base
  script:
    - uv run pytest --cov=elasticode --cov-report=term-missing --junitxml=report.xml
  artifacts:
    when: always
    reports:
      junit: report.xml

# ──────────────────────────────────────────────
# Build stage: Docker image on version tags
# ──────────────────────────────────────────────

build-docker:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
  script:
    - docker build -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_TAG" -t "$CI_REGISTRY_IMAGE:latest" .
    - docker push "$CI_REGISTRY_IMAGE:$CI_COMMIT_TAG"
    - docker push "$CI_REGISTRY_IMAGE:latest"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v/

# ──────────────────────────────────────────────
# Publish stage: PyPI package on version tags
# ──────────────────────────────────────────────

publish-pypi:
  stage: publish
  image: python:3.13-slim
  before_script:
    - pip install uv
  script:
    - uv build
    - uv publish --token "$PYPI_TOKEN"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v/
